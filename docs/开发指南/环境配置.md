# 🛠️ 环境配置指南

完整的生产就绪 Next.js 框架配置指南。

## 📋 前置要求

- **Node.js** >= 18.0.0
- **npm** >= 9.0.0
- **Supabase 账号**（免费）- [注册地址](https://supabase.com)
- **Git**

## 🔧 安装步骤

### 1. 安装项目依赖

```bash
npm install
```

### 2. 创建 Supabase 项目

#### a. 注册并创建项目

1. 访问 [Supabase](https://supabase.com) 并登录
2. 点击 **"New Project"**
3. 填写项目信息：
   - **Name**: `prompt-attack`
   - **Database Password**: 设置强密码（务必保存！）
   - **Region**: 选择 `Northeast Asia (Tokyo)` 或离你最近的区域
   - **Pricing Plan**: `Free`
4. 点击 **"Create new project"**
5. 等待约 2 分钟完成初始化

#### b. 获取数据库连接信息

1. 进入项目 Dashboard
2. 点击 **Settings** ⚙️ → **Database**
3. 找到 **Connection string** 部分
4. 复制两个连接字符串：
   - **Connection Pooling** (端口 6543) - 用于 `DATABASE_URL`
   - **Direct Connection** (端口 5432) - 用于 `DIRECT_URL`

### 3. 配置环境变量

在项目根目录创建 `.env` 文件：

```env
# Supabase Database
# 从 Supabase Dashboard -> Settings -> Database 复制
DATABASE_URL="postgres://postgres.[project-ref]:[YOUR-PASSWORD]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"
DIRECT_URL="postgres://postgres.[project-ref]:[YOUR-PASSWORD]@aws-0-[region].pooler.supabase.com:5432/postgres"

# NextAuth 配置
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="generate-a-random-secret-here"

# GitHub OAuth（可选）
GITHUB_ID=""
GITHUB_SECRET=""

# OpenAI API
OPENAI_API_KEY="sk-your-key-here"

# 应用配置
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NODE_ENV="development"
```

**重要说明**:

- 将 `[YOUR-PASSWORD]` 替换为创建 Supabase 项目时设置的密码
- 将 `[project-ref]` 和 `[region]` 替换为实际值
- `DATABASE_URL`: 使用 Connection Pooling（6543 端口），用于应用查询
- `DIRECT_URL`: 使用 Direct Connection（5432 端口），用于数据库迁移

**生成 NEXTAUTH_SECRET:**

```bash
openssl rand -base64 32
```

> 📖 **详细 Supabase 配置**: 查看 [Supabase配置指南](../技术文档/Supabase配置指南.md)

### 4. 初始化数据库

配置好环境变量后，运行以下命令初始化 Supabase 数据库：

```bash
# 生成 Prisma Client
npx prisma generate

# 推送 schema 到 Supabase 数据库
npx prisma db push

# （可选）打开 Prisma Studio 查看数据库
npx prisma studio
```

**验证数据库连接**:

```bash
# 测试连接
npx prisma db pull

# 如果成功，会显示所有表结构
```

你也可以在 Supabase Dashboard 中：

1. 点击 **Table Editor** 查看已创建的表
2. 点击 **SQL Editor** 运行 SQL 查询

### 5. 启动开发服务器

```bash
npm run dev
```

应用将在 `http://localhost:3000` 运行

## ✅ 验证安装

### 检查健康端点

```bash
curl http://localhost:3000/api/health
```

预期响应：

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "services": {
    "database": "up"
  }
}
```

### 测试页面

- **首页**: http://localhost:3000
- **仪表板**: http://localhost:3000/dashboard
- **登录**: http://localhost:3000/login

## 🎯 开发命令

```bash
# 启动开发服务器
npm run dev

# 构建生产版本
npm run build

# 启动生产服务器
npm start

# 代码检查
npm run lint

# 代码格式化
npm run format

# 类型检查
npm run type-check

# 数据库命令
npm run db:push       # 推送 schema 变更
npm run db:studio     # 打开 Prisma Studio
npm run db:generate   # 生成 Prisma Client
npm run db:migrate    # 运行迁移
```

## 📦 项目结构

```
prompt-attack/
├── app/                          # Next.js App Router
│   ├── api/                      # API 路由
│   │   ├── auth/[...nextauth]/   # NextAuth
│   │   ├── register/             # 用户注册
│   │   ├── attack-test/          # 攻击测试
│   │   └── health/               # 健康检查
│   ├── dashboard/                # 仪表板页面
│   ├── login/                    # 登录页面
│   ├── layout.tsx                # 根布局
│   ├── page.tsx                  # 首页
│   ├── providers.tsx             # 客户端 Provider
│   └── globals.css               # 全局样式
│
├── src/
│   ├── components/               # React 组件
│   │   └── ui/                   # shadcn/ui 组件
│   ├── features/                 # 功能模块（待扩展）
│   ├── hooks/                    # 自定义 Hook
│   │   └── useAttackTest.ts
│   ├── lib/                      # 核心库
│   │   ├── db.ts                 # Prisma 客户端
│   │   ├── auth.ts               # NextAuth 配置
│   │   ├── auth-helpers.ts       # 认证工具
│   │   └── store.ts              # Zustand Store
│   ├── types/                    # TypeScript 类型
│   │   ├── index.ts
│   │   └── next-auth.d.ts
│   └── utils/                    # 工具函数
│       ├── cn.ts                 # 类名合并
│       ├── errors.ts             # 错误处理
│       └── validators.ts         # Zod Schema
│
├── prisma/
│   └── schema.prisma             # 数据库 Schema
│
├── docs/                         # 文档
│   ├── 开发指南/
│   ├── 技术文档/
│   ├── 业务文档/
│   └── 部署运维/
│
├── .eslintrc.json                # ESLint 配置
├── .prettierrc                   # Prettier 配置
├── next.config.js                # Next.js 配置
├── tailwind.config.ts            # Tailwind 配置
├── tsconfig.json                 # TypeScript 配置
└── package.json
```

## 🔐 安全注意事项

1. **绝不提交 `.env`** - 包含敏感凭证
2. **使用强密钥** - 用 `openssl rand -base64 32` 生成
3. **保护 API 密钥** - 仅存储在环境变量中
4. **启用 HTTPS** - 生产环境必须

## 🚨 常见问题

### 问题：Prisma Client 错误

```
Error: PrismaClient is unable to be run in the browser
```

**解决方案**: 确保 Prisma 仅在服务端组件或 API 路由中使用。

### 问题：Supabase 数据库连接失败

```
Can't reach database server
```

**解决方案**:

1. 检查 Supabase 项目是否处于活动状态（Free Plan 可能会暂停）
2. 验证 `DATABASE_URL` 和 `DIRECT_URL` 正确
3. 确认密码中的特殊字符已正确 URL 编码
4. 检查网络连接

### 问题：连接池耗尽

```
Error: Too many connections
```

**解决方案**:

1. 确保使用 `DATABASE_URL`（Connection Pooling）而非 `DIRECT_URL`
2. 添加 `connection_limit=1` 参数到连接字符串
3. 在 Supabase Dashboard 检查连接数使用情况

### 问题：NextAuth 错误

```
[next-auth][error][SIGNIN_EMAIL_ERROR]
```

**解决方案**: 检查 `.env` 中是否设置了 NEXTAUTH_SECRET

### 问题：TypeScript 错误

```
Cannot find module '@/...'
```

**解决方案**: 运行 `npm install` 并重启 TypeScript 服务器

## 📚 下一步

配置完成后，你可以：

1. **添加防御逻辑**: 在 `app/api/attack-test/route.ts` 实现实际的攻击检测
2. **创建功能模块**: 在 `src/features/` 添加模块
3. **增加 UI 组件**: 在 `src/components/` 构建组件
4. **自定义主题**: 编辑 `tailwind.config.ts` 中的颜色
5. **部署**: 按照部署指南进行

## 🤝 需要帮助？

- 查看 [快速开始.md](./快速开始.md) 了解项目概览
- 查看 [项目结构.md](./项目结构.md) 了解代码组织
- 阅读 [业务文档](../业务文档/) 了解功能详情
- 提交 Issue 到 GitHub

---

✅ 配置完成！开始构建你的 Prompt Attack 防御系统。
