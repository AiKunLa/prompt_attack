# 📖 开发规范

代码风格、命名约定和最佳实践指南。

## 🎨 代码风格

### TypeScript 配置

项目使用 **TypeScript Strict 模式**：

```json
{
  "strict": true,
  "noImplicitAny": true,
  "strictNullChecks": true,
  "noUncheckedIndexedAccess": true,
  "noUnusedLocals": true,
  "noUnusedParameters": true
}
```

### ESLint 配置

```bash
# 检查代码
npm run lint

# 自动修复
npm run lint --fix
```

### Prettier 配置

```bash
# 格式化代码
npm run format
```

配置（`.prettierrc`）：

```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
```

## 📝 命名规范

### 文件命名

```
✅ 组件: PascalCase
   AttackDemo.tsx
   DefensePanel.tsx

✅ Hook: useCamelCase
   useAttackTest.ts
   useDefenseConfig.ts

✅ 工具: camelCase
   validators.ts
   formatters.ts

✅ 类型: camelCase 或 .d.ts
   index.ts
   next-auth.d.ts

✅ 页面: kebab-case
   app/login/page.tsx
   app/dashboard/page.tsx
```

### 变量命名

```typescript
// ✅ 常量: UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;
const API_BASE_URL = 'http://localhost:3000';

// ✅ 普通变量: camelCase
const userInput = 'test';
const defenseLevel = 'high';

// ✅ 类名: PascalCase
class DefenseSystem {}
class InputValidator {}

// ✅ 私有属性: 前缀 _
class MyClass {
  private _privateProperty = 'private';
  public publicProperty = 'public';
}

// ✅ 布尔值: is/has/should 前缀
const isLoading = false;
const hasError = true;
const shouldValidate = true;
```

### 函数命名

```typescript
// ✅ 动词开头
function fetchUserData() {}
function validateInput() {}
function handleSubmit() {}

// ✅ 布尔返回值: is/has/can
function isValidEmail() {}
function hasPermission() {}
function canDelete() {}

// ✅ 事件处理: handle 前缀
function handleClick() {}
function handleInputChange() {}
```

## 🏗️ 组件规范

### React 组件结构

```tsx
'use client'; // 如果是客户端组件

import { useState, useEffect } from 'react';

import { Button } from '@/components/ui/button';
import { useAttackTest } from '@/hooks/useAttackTest';
import { cn } from '@/utils/cn';
import type { AttackTestInput } from '@/types';

/**
 * 组件描述
 *
 * @param props - 组件属性
 * @returns JSX 元素
 */
interface MyComponentProps {
  title: string;
  onSubmit: (data: AttackTestInput) => void;
  className?: string;
}

export function MyComponent({ title, onSubmit, className }: MyComponentProps) {
  // 1. Hook 调用（按字母顺序）
  const [state, setState] = useState<string>('');
  const { runTest } = useAttackTest();

  // 2. 副作用
  useEffect(() => {
    // 副作用逻辑
  }, [dependencies]);

  // 3. 事件处理函数
  const handleClick = () => {
    // 处理逻辑
  };

  // 4. 计算值
  const displayValue = state.toUpperCase();

  // 5. 提前返回（如有）
  if (!title) {
    return null;
  }

  // 6. 渲染
  return (
    <div className={cn('my-component', className)}>
      <h2>{title}</h2>
      <Button onClick={handleClick}>{displayValue}</Button>
    </div>
  );
}
```

### 组件导出

```typescript
// ✅ 推荐: 命名导出
export function MyComponent() {}

// ❌ 避免: 默认导出（在组件中）
export default MyComponent;

// ✅ 页面组件例外（Next.js 要求）
// app/page.tsx
export default function HomePage() {}
```

## 📦 导入规范

### 导入顺序

使用 ESLint 自动排序：

```typescript
// 1. React/Next.js
import { useState } from 'react';
import { useRouter } from 'next/navigation';

// 2. 第三方库
import { z } from 'zod';

// 3. 内部别名导入
import { Button } from '@/components/ui/button';
import { useAttackTest } from '@/hooks/useAttackTest';
import { prisma } from '@/lib/db';

// 4. 相对导入
import { helper } from './helper';

// 5. 类型导入
import type { User } from '@/types';
```

### 类型导入

```typescript
// ✅ 推荐: 使用 type 关键字
import type { User, ApiResponse } from '@/types';

// ✅ 混合导入
import { useState, type FC } from 'react';
```

## 🔤 注释规范

### JSDoc 注释

````typescript
/**
 * 函数功能描述
 *
 * @param input - 输入参数说明
 * @param options - 选项对象
 * @param options.level - 防御等级
 * @returns 返回值说明
 *
 * @example
 * ```ts
 * const result = await validateInput('test', { level: 'high' });
 * ```
 */
async function validateInput(
  input: string,
  options: { level: DefenseLevel }
): Promise<ValidationResult> {
  // 实现
}
````

### 代码注释

```typescript
// ✅ 解释"为什么"，不是"是什么"
// 使用 bcrypt 而非 scrypt，因为更好的跨平台支持
const hash = await bcrypt.hash(password, 12);

// ❌ 避免显而易见的注释
// 设置 loading 为 true
setLoading(true);
```

### TODO 注释

```typescript
// TODO: 实现实际的 LLM API 调用
// TODO(username): 添加错误重试逻辑
// FIXME: 修复在 Safari 中的布局问题
// HACK: 临时解决方案，等待上游修复
```

## 🎯 类型安全

### 避免 any

```typescript
// ❌ 避免
function process(data: any) {}

// ✅ 使用 unknown
function process(data: unknown) {
  if (typeof data === 'string') {
    // 类型收窄
  }
}

// ✅ 使用泛型
function process<T extends BaseType>(data: T): T {
  return data;
}
```

### 使用 Zod 验证

```typescript
import { z } from 'zod';

// 定义 schema
const userSchema = z.object({
  email: z.string().email(),
  age: z.number().min(0).max(120),
});

// 推断类型
type User = z.infer<typeof userSchema>;

// 验证
function createUser(data: unknown): User {
  return userSchema.parse(data);
}
```

### 类型守卫

```typescript
// 类型守卫函数
function isUser(value: unknown): value is User {
  return (
    typeof value === 'object' &&
    value !== null &&
    'id' in value &&
    'email' in value
  );
}

// 使用
if (isUser(data)) {
  // data 现在是 User 类型
  console.log(data.email);
}
```

## 🔧 Hook 规范

```typescript
/**
 * 自定义 Hook
 */
export function useMyFeature(initialValue: string) {
  const [value, setValue] = useState(initialValue);
  const [loading, setLoading] = useState(false);

  const doSomething = useCallback(async () => {
    setLoading(true);
    try {
      // 异步操作
    } finally {
      setLoading(false);
    }
  }, [dependencies]);

  return {
    value,
    loading,
    doSomething,
  };
}
```

## 📋 错误处理

### 自定义错误

```typescript
// 使用自定义错误类
throw new ValidationError('Invalid input');
throw new AuthenticationError('Not authenticated');

// API 路由中
try {
  // 业务逻辑
} catch (error) {
  const { message, statusCode, code } = handleError(error);
  return NextResponse.json(
    { success: false, error: { code, message } },
    { status: statusCode }
  );
}
```

### 异步错误

```typescript
// ✅ 使用 try-catch
async function fetchData() {
  try {
    const response = await fetch(url);
    return await response.json();
  } catch (error) {
    console.error('Fetch failed:', error);
    throw new AppError('Failed to fetch data');
  }
}

// ✅ Promise 错误处理
promise.then(handleSuccess).catch(handleError).finally(cleanup);
```

## 🎨 Tailwind 规范

### 类名顺序

```tsx
// ✅ 推荐顺序: 布局 → 间距 → 排版 → 视觉 → 其他
<div
  className={cn(
    // 布局
    'flex items-center justify-between',
    // 间距
    'gap-2 px-4 py-2',
    // 排版
    'text-sm font-medium',
    // 视觉
    'bg-primary rounded-lg text-white',
    // 状态
    'hover:bg-primary/90 focus:ring-2',
    // 响应式
    'md:px-6 lg:px-8',
    // 自定义
    className
  )}
>
  {children}
</div>
```

### 使用 cn 工具

```tsx
import { cn } from '@/utils/cn';

// ✅ 条件类名
<div
  className={cn(
    'base-classes',
    isActive && 'active-classes',
    isDisabled && 'disabled-classes',
    className
  )}
/>;
```

## 🧪 测试规范（未来）

```typescript
import { render, screen } from '@testing-library/react';

describe('MyComponent', () => {
  it('should render correctly', () => {
    render(<MyComponent title="Test" />);
    expect(screen.getByText('Test')).toBeInTheDocument();
  });

  it('should handle click events', async () => {
    const onSubmit = jest.fn();
    render(<MyComponent onSubmit={onSubmit} />);

    await userEvent.click(screen.getByRole('button'));
    expect(onSubmit).toHaveBeenCalled();
  });
});
```

## 📊 性能优化

### React 优化

```tsx
// ✅ 使用 memo
export const MyComponent = memo(function MyComponent(props) {
  // ...
});

// ✅ 使用 useCallback
const handleClick = useCallback(() => {
  // ...
}, [dependencies]);

// ✅ 使用 useMemo
const expensiveValue = useMemo(() => {
  return computeExpensiveValue(data);
}, [data]);
```

### 代码分割

```tsx
// ✅ 动态导入
import dynamic from 'next/dynamic';

const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <p>Loading...</p>,
});
```

## 🔒 安全规范

```typescript
// ✅ 验证所有用户输入
const validation = schema.safeParse(input);
if (!validation.success) {
  throw new ValidationError(validation.error.message);
}

// ✅ 使用参数化查询（Prisma 自动处理）
const user = await prisma.user.findUnique({
  where: { email },
});

// ❌ 绝不直接拼接 SQL
// const query = `SELECT * FROM users WHERE email = '${email}'`;

// ✅ 清理输出
const safeHtml = DOMPurify.sanitize(html);
```

## 📝 Git 提交规范

```bash
# 提交格式
<type>(<scope>): <subject>

# 类型
feat:     新功能
fix:      修复
docs:     文档
style:    格式（不影响代码运行）
refactor: 重构
test:     测试
chore:    构建/工具

# 示例
feat(auth): 添加 GitHub OAuth 登录
fix(api): 修复攻击测试超时问题
docs(readme): 更新安装说明
```

## ✅ 代码审查清单

- [ ] 代码符合 TypeScript strict 模式
- [ ] 所有函数都有类型注解
- [ ] 使用 Zod 验证用户输入
- [ ] 错误处理完整
- [ ] 组件有适当的注释
- [ ] 没有 console.log（除调试外）
- [ ] 遵循命名规范
- [ ] 代码格式化（Prettier）
- [ ] 通过 ESLint 检查
- [ ] 没有未使用的导入

---

**最后更新**: 2025-01-15
**维护者**: 项目团队
