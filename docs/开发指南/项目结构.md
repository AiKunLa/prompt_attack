# 📁 项目结构指南

代码组织规范和最佳实践。

## 🏗️ 架构总览

本项目遵循 Next.js 14 App Router 规范，采用功能模块化架构。

```
prompt-attack/
├── app/              # Next.js App Router (页面和 API 路由)
├── src/              # 应用源代码
├── prisma/           # 数据库 Schema 和迁移
├── public/           # 静态资源
├── docs/             # 项目文档
└── 配置文件          # TypeScript、ESLint、Tailwind 等
```

## 📂 目录详解

### `/app` - Next.js App Router

**用途**: 页面、布局和 API 路由。

```
app/
├── api/                      # API 路由
│   ├── auth/[...nextauth]/   # NextAuth.js 动态路由
│   │   └── route.ts          # GET/POST 处理器
│   ├── register/
│   │   └── route.ts          # POST /api/register
│   ├── attack-test/
│   │   └── route.ts          # POST /api/attack-test
│   └── health/
│       └── route.ts          # GET /api/health
│
├── dashboard/                # /dashboard 路由
│   └── page.tsx              # 仪表板页面组件
├── login/                    # /login 路由
│   └── page.tsx              # 登录页面组件
│
├── layout.tsx                # 根布局（包裹所有页面）
├── page.tsx                  # 首页 (/)
├── providers.tsx             # 客户端 Provider（SessionProvider）
└── globals.css               # 全局样式 + Tailwind
```

**约定**:

- `page.tsx` = 路由页面组件
- `layout.tsx` = 共享布局
- `route.ts` = API 路由处理器
- 客户端组件使用 `"use client"` 指令
- 默认为服务端组件

### `/src` - 应用源码

**用途**: 可复用代码、业务逻辑、工具函数。

#### `/src/components` - React 组件

```
src/components/
├── ui/                  # shadcn/ui 组件（原子级）
│   ├── button.tsx
│   ├── input.tsx
│   ├── card.tsx
│   └── ...              # 按需添加更多
│
└── [feature]/           # 功能特定组件
    └── example.tsx
```

**约定**:

- `ui/` = 展示型组件（shadcn/ui）
- 功能文件夹 = 领域特定组件
- 使用 PascalCase 命名组件文件
- 导出命名组件

#### `/src/features` - 功能模块

```
src/features/
└── [feature-name]/
    ├── components/      # 功能组件
    ├── hooks/           # 功能 Hook
    ├── types.ts         # 功能类型
    ├── api.ts           # API 调用
    └── index.ts         # 公开导出
```

**示例**（未来）:

```
src/features/
└── attack-defense/
    ├── components/
    │   ├── AttackInput.tsx
    │   └── DefenseConfig.tsx
    ├── hooks/
    │   └── useDefenseSystem.ts
    ├── types.ts
    └── api.ts
```

**约定**:

- 一个功能 = 一个目录
- 保持功能隔离
- 通过 `index.ts` 导出

#### `/src/lib` - 核心库

```
src/lib/
├── db.ts               # Prisma 客户端单例
├── auth.ts             # NextAuth 配置
├── auth-helpers.ts     # 认证工具
└── store.ts            # Zustand Store
```

**用途**: 核心基础设施和配置。

**约定**:

- 保持最小化 - 仅共享基础设施
- 无业务逻辑
- 仅服务端安全代码

#### `/src/types` - TypeScript 类型

```
src/types/
├── index.ts            # 共享类型
└── next-auth.d.ts      # NextAuth 类型扩展
```

**约定**:

- 全局类型放在 `index.ts`
- 模块扩展放在 `.d.ts` 文件
- 优先使用 Zod Schema + 类型推断

#### `/src/utils` - 工具函数

```
src/utils/
├── cn.ts               # Tailwind 类名合并
├── errors.ts           # 错误类
└── validators.ts       # Zod 验证 Schema
```

**约定**:

- 仅纯函数
- 良好文档
- 可测试

#### `/src/hooks` - 自定义 React Hook

```
src/hooks/
├── useAttackTest.ts    # 攻击测试 Hook
└── ...
```

**约定**:

- 以 `use` 开头
- 一个 Hook 一个文件
- 记录参数

### `/prisma` - 数据库

```
prisma/
├── schema.prisma       # 数据库 Schema
└── migrations/         # 迁移历史（自动生成）
```

**约定**:

- 仅编辑 `schema.prisma`
- 运行 `prisma migrate dev` 进行变更
- 绝不手动编辑迁移文件

### `/docs` - 项目文档

```
docs/
├── 开发指南/
│   ├── 快速开始.md
│   ├── 环境配置.md
│   ├── 项目结构.md
│   └── 开发规范.md
├── 技术文档/
│   ├── API文档.md
│   ├── 数据库设计.md
│   └── 认证系统.md
├── 业务文档/
│   ├── 攻击类型详解.md
│   ├── 防御策略详解.md
│   └── 系统架构.md
└── 部署运维/
    └── 部署指南.md
```

## 🎯 文件命名规范

| 类型         | 规范                  | 示例                         |
| ------------ | --------------------- | ---------------------------- |
| **组件**     | PascalCase.tsx        | `AttackDemo.tsx`             |
| **页面**     | lowercase/kebab-case  | `app/dashboard/page.tsx`     |
| **工具**     | camelCase.ts          | `cn.ts`                      |
| **类型**     | camelCase.ts 或 .d.ts | `index.ts`, `next-auth.d.ts` |
| **Hook**     | useCamelCase.ts       | `useAttackTest.ts`           |
| **API 路由** | route.ts              | `app/api/*/route.ts`         |

## 📝 代码组织模式

### 模式 1: 就近原则

相关代码放在一起：

```tsx
// ✅ 推荐
src/features/attack-defense/
├── components/
│   └── AttackInput.tsx
├── hooks/
│   └── useAttackInput.ts
└── types.ts

// ❌ 避免
src/components/AttackInput.tsx
src/hooks/useAttackInput.ts
src/types/attack-types.ts
```

### 模式 2: 桶式导出

使用 `index.ts` 实现清晰导入：

```typescript
// src/features/attack-defense/index.ts
export { AttackInput } from './components/AttackInput';
export { useAttackInput } from './hooks/useAttackInput';
export type { AttackInputProps } from './types';

// 使用
import { AttackInput, useAttackInput } from '@/features/attack-defense';
```

### 模式 3: 服务端/客户端分离

```tsx
// ✅ 服务端组件（默认）
// app/dashboard/page.tsx
import { getServerSession } from 'next-auth';

export default async function DashboardPage() {
  const session = await getServerSession();
  return <ClientComponent session={session} />;
}

// ✅ 客户端组件（显式）
// src/components/ClientComponent.tsx
('use client');

import { useState } from 'react';

export function ClientComponent({ session }) {
  const [state, setState] = useState();
  // ...
}
```

## 🔍 导入路径别名

在 `tsconfig.json` 中配置：

```typescript
// 可用别名
import { Button } from '@/components/ui/button';
import { useAttackTest } from '@/hooks/useAttackTest';
import { prisma } from '@/lib/db';
import type { ApiResponse } from '@/types';
import { cn } from '@/utils/cn';
```

## 📊 状态管理策略

### 1. 服务端状态（数据库）

- 在服务端组件或 API 路由中使用 Prisma 查询
- 无客户端缓存

### 2. 客户端状态（Zustand）

- 全局状态: `src/lib/store.ts`
- 功能状态: `src/features/[name]/store.ts`

### 3. URL 状态

- 使用 Next.js `searchParams` 处理过滤、分页等

### 4. 表单状态

- 使用受控组件 + `useState`
- 或复杂表单使用 React Hook Form

## 🧪 测试结构（未来）

```
__tests__/
├── unit/
│   ├── components/
│   ├── hooks/
│   └── utils/
├── integration/
│   └── api/
└── e2e/
    └── flows/
```

## 📦 添加新功能

### 步骤

1. **创建功能目录**:

   ```
   src/features/my-feature/
   ```

2. **添加组件**:

   ```typescript
   src / features / my - feature / components / MyComponent.tsx;
   ```

3. **添加类型**:

   ```typescript
   src / features / my - feature / types.ts;
   ```

4. **添加 Hook**（如需）:

   ```typescript
   src / features / my - feature / hooks / useMyFeature.ts;
   ```

5. **添加 API 路由**（如需）:

   ```typescript
   app / api / my - feature / route.ts;
   ```

6. **通过 index 导出**:
   ```typescript
   src / features / my - feature / index.ts;
   ```

## 🎨 样式规范

1. **使用 Tailwind** 进行所有样式设置
2. **使用 `cn()` 工具** 处理条件类名
3. **遵循 shadcn/ui 模式** 构建组件
4. **保持内联** - 避免单独的 CSS 模块

```tsx
// ✅ 推荐
<div
  className={cn('flex items-center gap-2', isActive && 'bg-primary', className)}
>
  {children}
</div>
```

## 🔒 安全最佳实践

1. **API 路由**: 使用 Zod 验证所有输入
2. **数据库**: 使用 Prisma - 绝不使用原始 SQL
3. **认证**: 在受保护路由中检查会话
4. **密钥**: 存储在 `.env`，绝不放在代码中
5. **客户端/服务端**: 不要向客户端暴露服务端代码

---

**最后更新**: 2025-01-15
**维护者**: 项目团队
