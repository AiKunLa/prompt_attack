# 📊 数据库种子数据

本文档介绍如何向数据库中插入测试数据。

---

## 🎯 **为什么需要种子数据？**

种子数据可以帮助你：

- ✅ **快速测试功能** - 不需要手动创建大量测试记录
- ✅ **查看真实效果** - 看到完整的统计数据和图表
- ✅ **演示项目** - 向他人展示完整的功能
- ✅ **开发调试** - 快速重置测试环境

---

## 📝 **方法一：使用 Node.js 脚本（推荐）**

### **步骤 1: 安装依赖**

```bash
pnpm install
```

### **步骤 2: 配置环境变量**

确保 `.env.local` 文件包含以下配置：

```env
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# Service Role Key (用于种子脚本)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

**如何获取 Service Role Key？**

1. 访问 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单 **Settings** → **API**
4. 在 **Project API keys** 部分找到 `service_role` 密钥
5. 复制并粘贴到 `.env.local` 文件

⚠️ **注意**: Service Role Key 是敏感信息，**不要**提交到 Git 仓库！

### **步骤 3: 注册测试用户**

在运行种子脚本之前，你需要至少注册一个测试用户：

1. 启动开发服务器：

   ```bash
   pnpm dev
   ```

2. 访问 http://localhost:3000/login

3. 注册一个测试用户，例如：
   - 姓名: `测试用户`
   - 邮箱: `test@example.com`
   - 密码: `Test1234`

### **步骤 4: 运行种子脚本**

```bash
pnpm seed
```

**预期输出**:

```
🌱 开始插入种子数据...

📋 步骤 1: 查找用户...
✅ 找到用户: test@example.com (ID: 12345678-1234-1234-1234-123456789abc)

📋 步骤 2: 检查现有数据...

📋 步骤 3: 插入测试数据...
  ✅ 插入成功: PROMPT_INJECTION (NONE) - 通过
  ✅ 插入成功: JAILBREAK (ADVANCED) - 已拦截
  ✅ 插入成功: CONTEXT_OVERFLOW (BASIC) - 已拦截
  ...

📊 插入结果:
  ✅ 成功: 10 条
  ❌ 失败: 0 条

📋 步骤 4: 验证数据...
  总测试记录: 10 条
  已拦截: 5 条
  通过: 5 条

🎉 种子数据插入完成！

现在你可以:
1. 访问 http://localhost:3000/login 登录
   邮箱: test@example.com
2. 访问 http://localhost:3000/dashboard 查看数据
3. 查看统计信息和测试记录
```

### **步骤 5: 查看结果**

1. 访问 http://localhost:3000/login 登录
2. 进入 Dashboard 查看：
   - 📊 统计卡片显示总测试数、拦截数、通过数
   - 📝 测试记录按时间倒序排列
   - 🎯 各种攻击类型的测试样例

---

## 📝 **方法二：使用 SQL 脚本**

如果你更喜欢直接执行 SQL，可以使用这个方法。

### **步骤 1: 获取用户 ID**

首先需要获取你的用户 ID：

1. 访问 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单 **Authentication** → **Users**
4. 找到你的测试用户，复制 **UID**（UUID 格式）

或者在 SQL Editor 中运行：

```sql
SELECT id, email FROM auth.users;
```

### **步骤 2: 编辑 SQL 文件**

打开 `supabase/seed.sql` 文件，将所有的 `YOUR_USER_ID` 替换为实际的用户 ID。

例如，如果你的用户 ID 是 `12345678-1234-1234-1234-123456789abc`：

```sql
-- 替换前
INSERT INTO attack_tests (
  user_id,
  ...
) VALUES (
  'YOUR_USER_ID',  -- ❌ 替换这个
  ...
);

-- 替换后
INSERT INTO attack_tests (
  user_id,
  ...
) VALUES (
  '12345678-1234-1234-1234-123456789abc',  -- ✅ 替换为实际 ID
  ...
);
```

### **步骤 3: 执行 SQL**

1. 访问 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧菜单 **SQL Editor**
4. 点击 **New query**
5. 复制 `supabase/seed.sql` 文件的内容并粘贴
6. 点击 **Run** 执行

### **步骤 4: 验证数据**

在 SQL Editor 中运行：

```sql
-- 查看总记录数
SELECT COUNT(*) as total_records
FROM attack_tests
WHERE user_id = 'YOUR_USER_ID';

-- 查看所有记录
SELECT attack_type, defense_level, is_blocked, created_at
FROM attack_tests
WHERE user_id = 'YOUR_USER_ID'
ORDER BY created_at DESC;
```

---

## 🗑️ **清理测试数据**

如果你想删除所有测试数据并重新开始：

### **使用 SQL（在 Supabase Dashboard）**

```sql
-- 删除所有测试记录
DELETE FROM attack_tests WHERE user_id = 'YOUR_USER_ID';
```

### **或者在应用中手动删除**

目前应用中还没有批量删除功能，你可以：

1. 在 Supabase Dashboard → **Table Editor** 中手动删除
2. 或者添加一个批量删除 API（可选）

---

## 📊 **种子数据内容**

脚本会插入 **10 条测试记录**，包含：

| 攻击类型          | 防御级别 | 是否拦截 | 描述               |
| ----------------- | -------- | -------- | ------------------ |
| PROMPT_INJECTION  | NONE     | ❌ 否    | 尝试忽略之前的指令 |
| JAILBREAK         | ADVANCED | ✅ 是    | DAN 越狱攻击       |
| CONTEXT_OVERFLOW  | BASIC    | ✅ 是    | 超长输入攻击       |
| ROLE_MANIPULATION | BASIC    | ❌ 否    | 角色操纵攻击       |
| DELIMITER_ATTACK  | PARANOID | ✅ 是    | 分隔符注入攻击     |
| PROMPT_INJECTION  | BASIC    | ❌ 否    | 正常查询           |
| JAILBREAK         | BASIC    | ❌ 否    | 正常请求           |
| CONTEXT_OVERFLOW  | ADVANCED | ✅ 是    | 超长输入           |
| ROLE_MANIPULATION | PARANOID | ✅ 是    | 权限提升           |
| DELIMITER_ATTACK  | BASIC    | ❌ 否    | 正常问题           |

**统计结果**:

- 总记录: **10 条**
- 已拦截: **5 条**
- 通过: **5 条**
- 拦截率: **50%**

---

## ❓ **常见问题**

### **Q1: 运行 `pnpm seed` 报错 "没有找到用户"**

**A**: 你需要先注册一个测试用户：

1. 运行 `pnpm dev` 启动开发服务器
2. 访问 http://localhost:3000/login
3. 注册一个账号
4. 然后再运行 `pnpm seed`

---

### **Q2: 报错 "缺少 Supabase 配置"**

**A**: 检查你的 `.env.local` 文件是否包含：

```env
NEXT_PUBLIC_SUPABASE_URL=your-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

特别注意 **SUPABASE_SERVICE_ROLE_KEY** 是否配置正确。

---

### **Q3: 数据插入后在 Dashboard 中看不到**

**A**: 可能的原因：

1. **用户不匹配** - 确保你登录的用户和种子数据使用的是同一个用户
2. **RLS 策略** - 检查 Row Level Security 是否正确配置
3. **缓存问题** - 刷新页面或清除浏览器缓存

**解决方法**:

1. 退出登录
2. 使用种子脚本提示的邮箱重新登录
3. 访问 Dashboard 查看

---

### **Q4: 可以插入自定义数据吗？**

**A**: 可以！修改 `scripts/seed.ts` 文件中的 `seedData` 数组：

```typescript
const seedData = [
  {
    attack_type: 'PROMPT_INJECTION',
    defense_level: 'BASIC',
    input_text: '你的自定义输入...',
    output_text: '你的自定义输出...',
    is_blocked: false,
    metadata: {
      /* 自定义元数据 */
    },
    days_ago: 1,
  },
  // 添加更多数据...
];
```

然后运行 `pnpm seed`。

---

### **Q5: 如何重置数据库？**

**A**:

**方法 1: 删除测试记录**

```sql
DELETE FROM attack_tests WHERE user_id = 'YOUR_USER_ID';
```

**方法 2: 重新运行迁移**

```bash
# 在 Supabase Dashboard → SQL Editor 中
# 删除表并重新执行 supabase/migrations/20241015_initial_schema.sql
```

**方法 3: 重置整个项目**

- 在 Supabase Dashboard 中删除项目并重新创建

---

## 🎯 **下一步**

数据插入成功后，你可以：

1. ✅ **测试 Dashboard** - 查看统计卡片和测试记录
2. ✅ **测试搜索和筛选** - 如果有实现的话
3. ✅ **测试新功能** - 添加更多测试记录
4. ✅ **导出数据** - 用于分析或报告

---

## 📚 **相关文档**

- [数据库设计](../技术文档/数据库设计.md)
- [Supabase 配置指南](../技术文档/Supabase配置指南.md)
- [快速开始](./快速开始-Supabase.md)

---

**祝你使用愉快！** 🎉
