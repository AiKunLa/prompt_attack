# 🗄️ 数据库设计文档

Prisma Schema 和数据模型详解。

## 📊 数据库架构

使用 **Supabase (PostgreSQL)** + **Prisma ORM**。

- **数据库**: Supabase 托管的 PostgreSQL 14+
- **ORM**: Prisma
- **连接方式**: Connection Pooling（生产环境）/ Direct Connection（迁移）

## 🏗️ 数据模型

### User - 用户模型

用于身份认证和授权。

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // OAuth 用户为 null
  emailVerified DateTime?
  image         String?

  // 关系
  accounts      Account[]
  sessions      Session[]
  tests         AttackTest[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}
```

**字段说明**:

- `id`: CUID 格式的唯一标识符
- `email`: 用户邮箱（唯一）
- `password`: bcrypt 哈希密码（OAuth 用户为 null）
- `emailVerified`: 邮箱验证时间
- `accounts`: OAuth 账户关联
- `sessions`: 用户会话
- `tests`: 用户创建的攻击测试

### Account - OAuth 账户

存储第三方 OAuth 提供商信息。

```prisma
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}
```

**用途**: NextAuth.js OAuth 集成。

### Session - 会话

存储用户会话信息。

```prisma
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
```

### VerificationToken - 验证令牌

用于邮箱验证和密码重置。

```prisma
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

### AttackTest - 攻击测试

核心业务模型，存储攻击测试结果。

```prisma
model AttackTest {
  id            String       @id @default(cuid())

  // 测试数据
  input         String       @db.Text
  attackType    AttackType?
  defenseLevel  DefenseLevel @default(NONE)

  // 测试结果
  blocked       Boolean      @default(false)
  blockReason   String?
  blockStage    String?
  threatScore   Int          @default(0)

  // LLM 响应
  llmResponse   String?      @db.Text
  finalResponse String?      @db.Text

  // 元数据
  llmProvider   String       @default("openai")
  modelName     String?
  tokensUsed    Int?
  latencyMs     Int?

  // 关系
  userId        String?
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
  @@index([attackType])
  @@index([defenseLevel])
  @@index([createdAt])
}
```

**字段说明**:

- `input`: 测试输入内容
- `attackType`: 攻击类型（枚举）
- `defenseLevel`: 防御等级（枚举）
- `blocked`: 是否被拦截
- `threatScore`: 威胁评分（0-100）
- `llmResponse`: LLM 原始响应
- `finalResponse`: 最终输出
- `llmProvider`: LLM 提供商（openai/claude）
- `tokensUsed`: 消耗的 token 数
- `latencyMs`: 延迟（毫秒）

## 📝 枚举类型

### AttackType - 攻击类型

```prisma
enum AttackType {
  PROMPT_INJECTION      // 提示词注入
  JAILBREAK            // 越狱攻击
  CONTEXT_OVERFLOW     // 上下文溢出
  ROLE_MANIPULATION    // 角色操纵
  DELIMITER_ATTACK     // 分隔符攻击
}
```

### DefenseLevel - 防御等级

```prisma
enum DefenseLevel {
  NONE    // 无防御
  LOW     // 低级防御
  MEDIUM  // 中级防御
  HIGH    // 高级防御
}
```

## 🔗 关系图

```
User
├── accounts (1:N) Account
├── sessions (1:N) Session
└── tests (1:N) AttackTest

Account
└── user (N:1) User

Session
└── user (N:1) User

AttackTest
└── user (N:1) User (可为 null)
```

## 📊 索引策略

### 已创建的索引

```prisma
// User 表
@@index([email])           // 登录查询

// Account 表
@@index([userId])          // 用户关联查询

// Session 表
@@index([userId])          // 会话查询

// AttackTest 表
@@index([userId])          // 用户测试列表
@@index([attackType])      // 按攻击类型筛选
@@index([defenseLevel])    // 按防御等级筛选
@@index([createdAt])       // 时间排序
```

### 复合索引（未来优化）

```prisma
// 如需要按用户和时间查询
@@index([userId, createdAt])

// 如需要按攻击类型和防御等级统计
@@index([attackType, defenseLevel])
```

## 🔌 连接配置

### 环境变量

```env
# Connection Pooling - 用于应用查询
DATABASE_URL="postgres://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"

# Direct Connection - 用于迁移
DIRECT_URL="postgres://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres"
```

### Prisma Schema 配置

```prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
```

- `url`: 用于 Prisma Client 查询（Connection Pooling）
- `directUrl`: 用于迁移命令（Direct Connection）

## 🛠️ 常用查询

### 创建用户

```typescript
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    password: hashedPassword,
    name: 'Test User',
  },
});
```

### 查找用户

```typescript
const user = await prisma.user.findUnique({
  where: { email: 'user@example.com' },
  include: {
    tests: {
      take: 10,
      orderBy: { createdAt: 'desc' },
    },
  },
});
```

### 创建测试记录

```typescript
const test = await prisma.attackTest.create({
  data: {
    input: '测试输入',
    defenseLevel: 'HIGH',
    attackType: 'PROMPT_INJECTION',
    blocked: true,
    threatScore: 75,
    llmResponse: 'LLM 响应',
    finalResponse: '最终输出',
    userId: user.id,
  },
});
```

### 统计查询

```typescript
// 按攻击类型统计
const stats = await prisma.attackTest.groupBy({
  by: ['attackType'],
  _count: {
    id: true,
  },
  _avg: {
    threatScore: true,
  },
});

// 按防御等级统计拦截率
const blockRates = await prisma.attackTest.groupBy({
  by: ['defenseLevel'],
  _count: {
    id: true,
  },
  where: {
    blocked: true,
  },
});
```

## 🔧 数据库迁移

### 开发环境

使用 Supabase 时，推荐使用 `db push` 进行快速原型开发：

```bash
# 推送 schema 变更到 Supabase（不创建迁移文件）
npx prisma db push

# 或创建迁移（生产环境推荐）
npx prisma migrate dev --name add_user_model

# 重置数据库（⚠️ 删除所有数据）
npx prisma migrate reset
```

**注意**: 迁移命令会自动使用 `DIRECT_URL`（直连）。

### 生产环境

```bash
# 应用迁移到 Supabase
npx prisma migrate deploy

# 生成 Prisma Client
npx prisma generate
```

### Supabase Dashboard 迁移

你也可以在 Supabase Dashboard 中：

1. 打开 **SQL Editor**
2. 粘贴迁移 SQL
3. 点击 **Run** 执行

## 🎯 数据库管理

### 方式 1: Prisma Studio

本地图形化界面查看和编辑数据：

```bash
npx prisma studio
```

访问 `http://localhost:5555`

### 方式 2: Supabase Dashboard

在线管理数据库：

1. **Table Editor**: 可视化查看和编辑表数据
2. **SQL Editor**: 运行自定义 SQL 查询
3. **Database**: 查看连接信息和使用统计

**优势**:

- 无需本地工具
- 团队成员都可访问
- 实时数据同步

### 种子数据（未来）

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // 创建测试用户
  const user = await prisma.user.create({
    data: {
      email: 'test@example.com',
      name: 'Test User',
      password: await bcrypt.hash('password123', 12),
    },
  });

  // 创建示例测试
  await prisma.attackTest.create({
    data: {
      input: '示例攻击输入',
      defenseLevel: 'MEDIUM',
      attackType: 'PROMPT_INJECTION',
      userId: user.id,
    },
  });
}

main()
  .catch((e) => console.error(e))
  .finally(() => prisma.$disconnect());
```

运行种子：

```bash
npx prisma db seed
```

## 🔒 安全考虑

### 1. SQL 注入防护

Prisma 自动参数化查询，防止 SQL 注入：

```typescript
// ✅ 安全 - Prisma 自动处理
const user = await prisma.user.findUnique({
  where: { email: userInput },
});

// ❌ 危险 - 绝不使用原始 SQL
// await prisma.$executeRaw`SELECT * FROM users WHERE email = '${userInput}'`;
```

### 2. 敏感数据

```typescript
// ✅ 查询时排除密码
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    email: true,
    name: true,
    // 不包含 password
  },
});
```

### 3. 级联删除

```prisma
// 删除用户时自动删除关联数据
user User @relation(fields: [userId], references: [id], onDelete: Cascade)

// 删除用户时设置为 null
user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
```

## 📈 性能优化

### 1. 选择性查询

```typescript
// ✅ 只查询需要的字段
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    email: true,
  },
});

// ❌ 避免查询所有字段
// const user = await prisma.user.findUnique({ where: { id } });
```

### 2. 批量操作

```typescript
// ✅ 使用 createMany
await prisma.attackTest.createMany({
  data: tests,
  skipDuplicates: true,
});

// ❌ 避免循环创建
// for (const test of tests) {
//   await prisma.attackTest.create({ data: test });
// }
```

### 3. 事务

```typescript
// 原子操作
const result = await prisma.$transaction([
  prisma.user.create({ data: userData }),
  prisma.attackTest.create({ data: testData }),
]);
```

## 🔍 监控和调试

### 查询日志

```typescript
// lib/db.ts
const prisma = new PrismaClient({
  log:
    process.env.NODE_ENV === 'development'
      ? ['query', 'error', 'warn']
      : ['error'],
});
```

### 慢查询分析

```typescript
// 使用 Prisma 扩展分析查询
const prisma = new PrismaClient().$extends({
  query: {
    async $allOperations({ operation, model, args, query }) {
      const start = Date.now();
      const result = await query(args);
      const duration = Date.now() - start;

      if (duration > 1000) {
        console.warn(`Slow query: ${model}.${operation} took ${duration}ms`);
      }

      return result;
    },
  },
});
```

---

**最后更新**: 2025-01-15
**维护者**: 项目团队
