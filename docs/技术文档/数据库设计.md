# ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡æ–‡æ¡£

Prisma Schema å’Œæ•°æ®æ¨¡å‹è¯¦è§£ã€‚

## ğŸ“Š æ•°æ®åº“æ¶æ„

ä½¿ç”¨ **Supabase (PostgreSQL)** + **Prisma ORM**ã€‚

- **æ•°æ®åº“**: Supabase æ‰˜ç®¡çš„ PostgreSQL 14+
- **ORM**: Prisma
- **è¿æ¥æ–¹å¼**: Connection Poolingï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰/ Direct Connectionï¼ˆè¿ç§»ï¼‰

## ğŸ—ï¸ æ•°æ®æ¨¡å‹

### User - ç”¨æˆ·æ¨¡å‹

ç”¨äºèº«ä»½è®¤è¯å’Œæˆæƒã€‚

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // OAuth ç”¨æˆ·ä¸º null
  emailVerified DateTime?
  image         String?

  // å…³ç³»
  accounts      Account[]
  sessions      Session[]
  tests         AttackTest[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
}
```

**å­—æ®µè¯´æ˜**:

- `id`: CUID æ ¼å¼çš„å”¯ä¸€æ ‡è¯†ç¬¦
- `email`: ç”¨æˆ·é‚®ç®±ï¼ˆå”¯ä¸€ï¼‰
- `password`: bcrypt å“ˆå¸Œå¯†ç ï¼ˆOAuth ç”¨æˆ·ä¸º nullï¼‰
- `emailVerified`: é‚®ç®±éªŒè¯æ—¶é—´
- `accounts`: OAuth è´¦æˆ·å…³è”
- `sessions`: ç”¨æˆ·ä¼šè¯
- `tests`: ç”¨æˆ·åˆ›å»ºçš„æ”»å‡»æµ‹è¯•

### Account - OAuth è´¦æˆ·

å­˜å‚¨ç¬¬ä¸‰æ–¹ OAuth æä¾›å•†ä¿¡æ¯ã€‚

```prisma
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}
```

**ç”¨é€”**: NextAuth.js OAuth é›†æˆã€‚

### Session - ä¼šè¯

å­˜å‚¨ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€‚

```prisma
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
```

### VerificationToken - éªŒè¯ä»¤ç‰Œ

ç”¨äºé‚®ç®±éªŒè¯å’Œå¯†ç é‡ç½®ã€‚

```prisma
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
```

### AttackTest - æ”»å‡»æµ‹è¯•

æ ¸å¿ƒä¸šåŠ¡æ¨¡å‹ï¼Œå­˜å‚¨æ”»å‡»æµ‹è¯•ç»“æœã€‚

```prisma
model AttackTest {
  id            String       @id @default(cuid())

  // æµ‹è¯•æ•°æ®
  input         String       @db.Text
  attackType    AttackType?
  defenseLevel  DefenseLevel @default(NONE)

  // æµ‹è¯•ç»“æœ
  blocked       Boolean      @default(false)
  blockReason   String?
  blockStage    String?
  threatScore   Int          @default(0)

  // LLM å“åº”
  llmResponse   String?      @db.Text
  finalResponse String?      @db.Text

  // å…ƒæ•°æ®
  llmProvider   String       @default("openai")
  modelName     String?
  tokensUsed    Int?
  latencyMs     Int?

  // å…³ç³»
  userId        String?
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
  @@index([attackType])
  @@index([defenseLevel])
  @@index([createdAt])
}
```

**å­—æ®µè¯´æ˜**:

- `input`: æµ‹è¯•è¾“å…¥å†…å®¹
- `attackType`: æ”»å‡»ç±»å‹ï¼ˆæšä¸¾ï¼‰
- `defenseLevel`: é˜²å¾¡ç­‰çº§ï¼ˆæšä¸¾ï¼‰
- `blocked`: æ˜¯å¦è¢«æ‹¦æˆª
- `threatScore`: å¨èƒè¯„åˆ†ï¼ˆ0-100ï¼‰
- `llmResponse`: LLM åŸå§‹å“åº”
- `finalResponse`: æœ€ç»ˆè¾“å‡º
- `llmProvider`: LLM æä¾›å•†ï¼ˆopenai/claudeï¼‰
- `tokensUsed`: æ¶ˆè€—çš„ token æ•°
- `latencyMs`: å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰

## ğŸ“ æšä¸¾ç±»å‹

### AttackType - æ”»å‡»ç±»å‹

```prisma
enum AttackType {
  PROMPT_INJECTION      // æç¤ºè¯æ³¨å…¥
  JAILBREAK            // è¶Šç‹±æ”»å‡»
  CONTEXT_OVERFLOW     // ä¸Šä¸‹æ–‡æº¢å‡º
  ROLE_MANIPULATION    // è§’è‰²æ“çºµ
  DELIMITER_ATTACK     // åˆ†éš”ç¬¦æ”»å‡»
}
```

### DefenseLevel - é˜²å¾¡ç­‰çº§

```prisma
enum DefenseLevel {
  NONE    // æ— é˜²å¾¡
  LOW     // ä½çº§é˜²å¾¡
  MEDIUM  // ä¸­çº§é˜²å¾¡
  HIGH    // é«˜çº§é˜²å¾¡
}
```

## ğŸ”— å…³ç³»å›¾

```
User
â”œâ”€â”€ accounts (1:N) Account
â”œâ”€â”€ sessions (1:N) Session
â””â”€â”€ tests (1:N) AttackTest

Account
â””â”€â”€ user (N:1) User

Session
â””â”€â”€ user (N:1) User

AttackTest
â””â”€â”€ user (N:1) User (å¯ä¸º null)
```

## ğŸ“Š ç´¢å¼•ç­–ç•¥

### å·²åˆ›å»ºçš„ç´¢å¼•

```prisma
// User è¡¨
@@index([email])           // ç™»å½•æŸ¥è¯¢

// Account è¡¨
@@index([userId])          // ç”¨æˆ·å…³è”æŸ¥è¯¢

// Session è¡¨
@@index([userId])          // ä¼šè¯æŸ¥è¯¢

// AttackTest è¡¨
@@index([userId])          // ç”¨æˆ·æµ‹è¯•åˆ—è¡¨
@@index([attackType])      // æŒ‰æ”»å‡»ç±»å‹ç­›é€‰
@@index([defenseLevel])    // æŒ‰é˜²å¾¡ç­‰çº§ç­›é€‰
@@index([createdAt])       // æ—¶é—´æ’åº
```

### å¤åˆç´¢å¼•ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

```prisma
// å¦‚éœ€è¦æŒ‰ç”¨æˆ·å’Œæ—¶é—´æŸ¥è¯¢
@@index([userId, createdAt])

// å¦‚éœ€è¦æŒ‰æ”»å‡»ç±»å‹å’Œé˜²å¾¡ç­‰çº§ç»Ÿè®¡
@@index([attackType, defenseLevel])
```

## ğŸ”Œ è¿æ¥é…ç½®

### ç¯å¢ƒå˜é‡

```env
# Connection Pooling - ç”¨äºåº”ç”¨æŸ¥è¯¢
DATABASE_URL="postgres://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"

# Direct Connection - ç”¨äºè¿ç§»
DIRECT_URL="postgres://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres"
```

### Prisma Schema é…ç½®

```prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
```

- `url`: ç”¨äº Prisma Client æŸ¥è¯¢ï¼ˆConnection Poolingï¼‰
- `directUrl`: ç”¨äºè¿ç§»å‘½ä»¤ï¼ˆDirect Connectionï¼‰

## ğŸ› ï¸ å¸¸ç”¨æŸ¥è¯¢

### åˆ›å»ºç”¨æˆ·

```typescript
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    password: hashedPassword,
    name: 'Test User',
  },
});
```

### æŸ¥æ‰¾ç”¨æˆ·

```typescript
const user = await prisma.user.findUnique({
  where: { email: 'user@example.com' },
  include: {
    tests: {
      take: 10,
      orderBy: { createdAt: 'desc' },
    },
  },
});
```

### åˆ›å»ºæµ‹è¯•è®°å½•

```typescript
const test = await prisma.attackTest.create({
  data: {
    input: 'æµ‹è¯•è¾“å…¥',
    defenseLevel: 'HIGH',
    attackType: 'PROMPT_INJECTION',
    blocked: true,
    threatScore: 75,
    llmResponse: 'LLM å“åº”',
    finalResponse: 'æœ€ç»ˆè¾“å‡º',
    userId: user.id,
  },
});
```

### ç»Ÿè®¡æŸ¥è¯¢

```typescript
// æŒ‰æ”»å‡»ç±»å‹ç»Ÿè®¡
const stats = await prisma.attackTest.groupBy({
  by: ['attackType'],
  _count: {
    id: true,
  },
  _avg: {
    threatScore: true,
  },
});

// æŒ‰é˜²å¾¡ç­‰çº§ç»Ÿè®¡æ‹¦æˆªç‡
const blockRates = await prisma.attackTest.groupBy({
  by: ['defenseLevel'],
  _count: {
    id: true,
  },
  where: {
    blocked: true,
  },
});
```

## ğŸ”§ æ•°æ®åº“è¿ç§»

### å¼€å‘ç¯å¢ƒ

ä½¿ç”¨ Supabase æ—¶ï¼Œæ¨èä½¿ç”¨ `db push` è¿›è¡Œå¿«é€ŸåŸå‹å¼€å‘ï¼š

```bash
# æ¨é€ schema å˜æ›´åˆ° Supabaseï¼ˆä¸åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼‰
npx prisma db push

# æˆ–åˆ›å»ºè¿ç§»ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
npx prisma migrate dev --name add_user_model

# é‡ç½®æ•°æ®åº“ï¼ˆâš ï¸ åˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
npx prisma migrate reset
```

**æ³¨æ„**: è¿ç§»å‘½ä»¤ä¼šè‡ªåŠ¨ä½¿ç”¨ `DIRECT_URL`ï¼ˆç›´è¿ï¼‰ã€‚

### ç”Ÿäº§ç¯å¢ƒ

```bash
# åº”ç”¨è¿ç§»åˆ° Supabase
npx prisma migrate deploy

# ç”Ÿæˆ Prisma Client
npx prisma generate
```

### Supabase Dashboard è¿ç§»

ä½ ä¹Ÿå¯ä»¥åœ¨ Supabase Dashboard ä¸­ï¼š

1. æ‰“å¼€ **SQL Editor**
2. ç²˜è´´è¿ç§» SQL
3. ç‚¹å‡» **Run** æ‰§è¡Œ

## ğŸ¯ æ•°æ®åº“ç®¡ç†

### æ–¹å¼ 1: Prisma Studio

æœ¬åœ°å›¾å½¢åŒ–ç•Œé¢æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®ï¼š

```bash
npx prisma studio
```

è®¿é—® `http://localhost:5555`

### æ–¹å¼ 2: Supabase Dashboard

åœ¨çº¿ç®¡ç†æ•°æ®åº“ï¼š

1. **Table Editor**: å¯è§†åŒ–æŸ¥çœ‹å’Œç¼–è¾‘è¡¨æ•°æ®
2. **SQL Editor**: è¿è¡Œè‡ªå®šä¹‰ SQL æŸ¥è¯¢
3. **Database**: æŸ¥çœ‹è¿æ¥ä¿¡æ¯å’Œä½¿ç”¨ç»Ÿè®¡

**ä¼˜åŠ¿**:

- æ— éœ€æœ¬åœ°å·¥å…·
- å›¢é˜Ÿæˆå‘˜éƒ½å¯è®¿é—®
- å®æ—¶æ•°æ®åŒæ­¥

### ç§å­æ•°æ®ï¼ˆæœªæ¥ï¼‰

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
  const user = await prisma.user.create({
    data: {
      email: 'test@example.com',
      name: 'Test User',
      password: await bcrypt.hash('password123', 12),
    },
  });

  // åˆ›å»ºç¤ºä¾‹æµ‹è¯•
  await prisma.attackTest.create({
    data: {
      input: 'ç¤ºä¾‹æ”»å‡»è¾“å…¥',
      defenseLevel: 'MEDIUM',
      attackType: 'PROMPT_INJECTION',
      userId: user.id,
    },
  });
}

main()
  .catch((e) => console.error(e))
  .finally(() => prisma.$disconnect());
```

è¿è¡Œç§å­ï¼š

```bash
npx prisma db seed
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. SQL æ³¨å…¥é˜²æŠ¤

Prisma è‡ªåŠ¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜²æ­¢ SQL æ³¨å…¥ï¼š

```typescript
// âœ… å®‰å…¨ - Prisma è‡ªåŠ¨å¤„ç†
const user = await prisma.user.findUnique({
  where: { email: userInput },
});

// âŒ å±é™© - ç»ä¸ä½¿ç”¨åŸå§‹ SQL
// await prisma.$executeRaw`SELECT * FROM users WHERE email = '${userInput}'`;
```

### 2. æ•æ„Ÿæ•°æ®

```typescript
// âœ… æŸ¥è¯¢æ—¶æ’é™¤å¯†ç 
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    email: true,
    name: true,
    // ä¸åŒ…å« password
  },
});
```

### 3. çº§è”åˆ é™¤

```prisma
// åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…³è”æ•°æ®
user User @relation(fields: [userId], references: [id], onDelete: Cascade)

// åˆ é™¤ç”¨æˆ·æ—¶è®¾ç½®ä¸º null
user User? @relation(fields: [userId], references: [id], onDelete: SetNull)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. é€‰æ‹©æ€§æŸ¥è¯¢

```typescript
// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    email: true,
  },
});

// âŒ é¿å…æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
// const user = await prisma.user.findUnique({ where: { id } });
```

### 2. æ‰¹é‡æ“ä½œ

```typescript
// âœ… ä½¿ç”¨ createMany
await prisma.attackTest.createMany({
  data: tests,
  skipDuplicates: true,
});

// âŒ é¿å…å¾ªç¯åˆ›å»º
// for (const test of tests) {
//   await prisma.attackTest.create({ data: test });
// }
```

### 3. äº‹åŠ¡

```typescript
// åŸå­æ“ä½œ
const result = await prisma.$transaction([
  prisma.user.create({ data: userData }),
  prisma.attackTest.create({ data: testData }),
]);
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥è¯¢æ—¥å¿—

```typescript
// lib/db.ts
const prisma = new PrismaClient({
  log:
    process.env.NODE_ENV === 'development'
      ? ['query', 'error', 'warn']
      : ['error'],
});
```

### æ…¢æŸ¥è¯¢åˆ†æ

```typescript
// ä½¿ç”¨ Prisma æ‰©å±•åˆ†ææŸ¥è¯¢
const prisma = new PrismaClient().$extends({
  query: {
    async $allOperations({ operation, model, args, query }) {
      const start = Date.now();
      const result = await query(args);
      const duration = Date.now() - start;

      if (duration > 1000) {
        console.warn(`Slow query: ${model}.${operation} took ${duration}ms`);
      }

      return result;
    },
  },
});
```

---

**æœ€åæ›´æ–°**: 2025-01-15
**ç»´æŠ¤è€…**: é¡¹ç›®å›¢é˜Ÿ
