# 🔐 认证系统文档

NextAuth.js 认证实现详解。

## 📋 认证架构

使用 **NextAuth.js v4** 实现完整的认证系统。

## 🏗️ 核心组件

### 1. NextAuth 配置

位置：`src/lib/auth.ts`

```typescript
export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),

  providers: [
    CredentialsProvider({
      /* ... */
    }),
    GitHubProvider({
      /* ... */
    }), // 可选
  ],

  session: {
    strategy: 'jwt',
    maxAge: 30 * 24 * 60 * 60, // 30 天
  },

  callbacks: {
    async jwt({ token, user }) {
      /* ... */
    },
    async session({ session, token }) {
      /* ... */
    },
  },
};
```

## 🔑 认证提供商

### Credentials Provider（邮箱/密码）

**工作流程**：

1. 用户提交邮箱和密码
2. 查询数据库查找用户
3. 使用 bcrypt 验证密码
4. 生成 JWT token
5. 返回用户信息

**实现代码**：

```typescript
CredentialsProvider({
  name: 'credentials',
  credentials: {
    email: { label: 'Email', type: 'email' },
    password: { label: 'Password', type: 'password' },
  },
  async authorize(credentials) {
    if (!credentials?.email || !credentials?.password) {
      throw new Error('Invalid credentials');
    }

    // 查找用户
    const user = await prisma.user.findUnique({
      where: { email: credentials.email },
    });

    if (!user || !user.password) {
      throw new Error('Invalid credentials');
    }

    // 验证密码
    const isPasswordValid = await bcrypt.compare(
      credentials.password,
      user.password
    );

    if (!isPasswordValid) {
      throw new Error('Invalid credentials');
    }

    return {
      id: user.id,
      email: user.email,
      name: user.name,
      image: user.image,
    };
  },
});
```

### GitHub OAuth Provider（可选）

**配置步骤**：

1. 在 GitHub 创建 OAuth App
2. 获取 Client ID 和 Secret
3. 配置环境变量
4. 添加到 providers

```typescript
GitHubProvider({
  clientId: process.env.GITHUB_ID!,
  clientSecret: process.env.GITHUB_SECRET!,
});
```

**GitHub OAuth App 设置**：

- Homepage URL: `http://localhost:3000`
- Authorization callback URL: `http://localhost:3000/api/auth/callback/github`

## 📦 数据模型

### User

```prisma
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // OAuth 用户为 null
  emailVerified DateTime?
  image         String?

  accounts      Account[]
  sessions      Session[]
}
```

### Account（OAuth）

```prisma
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  // ... 其他字段
}
```

### Session

```prisma
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
}
```

## 🔐 密码安全

### 密码哈希

使用 **bcrypt** 进行密码哈希：

```typescript
import bcrypt from 'bcryptjs';

// 注册时哈希密码
const hashedPassword = await bcrypt.hash(password, 12);

// 登录时验证密码
const isValid = await bcrypt.compare(inputPassword, hashedPassword);
```

**Salt Rounds**: 12（安全且性能平衡）

### 密码策略

在 `src/utils/validators.ts` 中定义：

```typescript
const registerSchema = z.object({
  email: z.string().email(),
  password: z
    .string()
    .min(8, '密码至少8个字符')
    .max(100, '密码太长')
    .regex(
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
      '密码必须包含大写、小写字母和数字'
    ),
});
```

**要求**：

- 最少 8 个字符
- 至少一个大写字母
- 至少一个小写字母
- 至少一个数字

## 🎫 Session 管理

### JWT Strategy

使用 JWT 而非数据库 session：

```typescript
session: {
  strategy: 'jwt',
  maxAge: 30 * 24 * 60 * 60, // 30 天
}
```

**优点**：

- 无需数据库查询
- 可扩展性好
- 适合无状态应用

**缺点**：

- 无法立即撤销
- Token 体积较大

### Callbacks

#### JWT Callback

在 token 中添加用户 ID：

```typescript
async jwt({ token, user }) {
  if (user) {
    token.id = user.id;
  }
  return token;
}
```

#### Session Callback

将 token 信息传递给 session：

```typescript
async session({ session, token }) {
  if (session.user) {
    session.user.id = token.id;
  }
  return session;
}
```

## 🛡️ 认证辅助函数

位置：`src/lib/auth-helpers.ts`

### getSession

获取当前会话：

```typescript
export async function getSession() {
  return await getServerSession(authOptions);
}
```

### getCurrentUser

获取当前用户或抛出错误：

```typescript
export async function getCurrentUser() {
  const session = await getSession();

  if (!session?.user) {
    throw new AuthenticationError('Not authenticated');
  }

  return session.user;
}
```

### isAuthenticated

检查是否已认证：

```typescript
export async function isAuthenticated(): Promise<boolean> {
  const session = await getSession();
  return !!session?.user;
}
```

## 🌐 API 路由

### NextAuth Route Handler

位置：`app/api/auth/[...nextauth]/route.ts`

```typescript
import NextAuth from 'next-auth';
import { authOptions } from '@/lib/auth';

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
```

**处理的端点**：

- `/api/auth/signin` - 登录
- `/api/auth/signout` - 登出
- `/api/auth/session` - 获取 session
- `/api/auth/callback/*` - OAuth 回调

### 注册端点

位置：`app/api/register/route.ts`

```typescript
export async function POST(req: NextRequest) {
  // 1. 验证输入
  const validation = registerSchema.safeParse(body);

  // 2. 检查用户是否存在
  const existingUser = await prisma.user.findUnique({
    where: { email },
  });

  // 3. 哈希密码
  const hashedPassword = await bcrypt.hash(password, 12);

  // 4. 创建用户
  const user = await prisma.user.create({
    data: { email, password: hashedPassword, name },
  });

  return NextResponse.json({ success: true, data: user });
}
```

## 🎨 客户端使用

### 登录

```typescript
import { signIn } from 'next-auth/react';

const handleLogin = async (email: string, password: string) => {
  const result = await signIn('credentials', {
    email,
    password,
    redirect: false,
  });

  if (result?.error) {
    console.error('Login failed');
  } else {
    router.push('/dashboard');
  }
};
```

### 登出

```typescript
import { signOut } from 'next-auth/react';

const handleLogout = () => {
  signOut({ callbackUrl: '/' });
};
```

### 获取 Session

```typescript
import { useSession } from 'next-auth/react';

function MyComponent() {
  const { data: session, status } = useSession();

  if (status === 'loading') return <div>Loading...</div>;
  if (status === 'unauthenticated') return <div>Please login</div>;

  return <div>Welcome, {session.user.email}</div>;
}
```

## 🔒 保护路由

### 服务端组件

```typescript
// app/dashboard/page.tsx
import { getCurrentUser } from '@/lib/auth-helpers';
import { redirect } from 'next/navigation';

export default async function DashboardPage() {
  try {
    const user = await getCurrentUser();
  } catch {
    redirect('/login');
  }

  return <div>Dashboard</div>;
}
```

### API 路由

```typescript
// app/api/protected/route.ts
import { getCurrentUser } from '@/lib/auth-helpers';

export async function GET() {
  try {
    const user = await getCurrentUser();
    // 处理请求
  } catch {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
}
```

### 客户端组件

```typescript
'use client';

import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export function ProtectedComponent() {
  const { status } = useSession();
  const router = useRouter();

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/login');
    }
  }, [status, router]);

  if (status === 'loading') return <div>Loading...</div>;

  return <div>Protected content</div>;
}
```

## 🔧 环境变量

必需的环境变量：

```env
# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-here"

# GitHub OAuth（可选）
GITHUB_ID="your-github-client-id"
GITHUB_SECRET="your-github-client-secret"
```

## 🚨 安全最佳实践

### 1. 使用强密钥

```bash
openssl rand -base64 32
```

### 2. HTTPS Only（生产环境）

```typescript
// next.config.js
async headers() {
  return [
    {
      headers: [
        {
          key: 'Strict-Transport-Security',
          value: 'max-age=63072000; includeSubDomains; preload',
        },
      ],
    },
  ];
}
```

### 3. CSRF 保护

NextAuth 自动启用 CSRF token。

### 4. 速率限制

```typescript
import { RateLimitError } from '@/utils/errors';

// 登录速率限制（建议使用 Redis）
const loginAttempts = new Map();

export async function checkRateLimit(email: string) {
  const attempts = loginAttempts.get(email) || 0;

  if (attempts > 5) {
    throw new RateLimitError('Too many login attempts');
  }

  loginAttempts.set(email, attempts + 1);
}
```

## 📊 Session 生命周期

```
1. 用户登录
   ↓
2. NextAuth 生成 JWT
   ↓
3. JWT 存储在 HTTP-only Cookie
   ↓
4. 每次请求自动发送 Cookie
   ↓
5. NextAuth 验证 JWT
   ↓
6. 提供 session 数据给应用
   ↓
7. 用户登出 → 删除 Cookie
```

## 🔄 刷新 Session

```typescript
// 客户端刷新 session
import { useSession } from 'next-auth/react';

const { update } = useSession();

// 更新 session
await update({
  name: 'New Name',
});
```

## 🧪 测试

### 测试登录

```typescript
import { signIn } from 'next-auth/react';

// Mock signIn
jest.mock('next-auth/react');

test('login with valid credentials', async () => {
  (signIn as jest.Mock).mockResolvedValue({ error: null });

  await handleLogin('test@example.com', 'password');

  expect(signIn).toHaveBeenCalledWith('credentials', {
    email: 'test@example.com',
    password: 'password',
    redirect: false,
  });
});
```

---

**最后更新**: 2025-01-15
**维护者**: 项目团队
